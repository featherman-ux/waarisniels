---
// src/components/Comments.astro
import { apiUrl } from '../lib/api';

export interface Props {
  slug: string;
  title?: string;
}
const { slug } = Astro.props;
const COMMENTS = apiUrl('/api/comments');
---
<section class="comments">
  <h2>Reacties</h2>

  <form id="c-form">
    <input type="text" name="name" placeholder="Naam (optioneel)" />
    <input type="text" name="website" class="hp" style="display:none" tabindex="-1" autocomplete="off" />
    <textarea name="message" required minlength="2" placeholder="Zeg iets leuks…"></textarea>
    <button type="submit">Plaats reactie</button>
  </form>

  <div id="c-list" aria-live="polite"></div>

  <script is:inline>
    const SLUG = {s: JSON.stringify({slug: slug})}.s.slug;
    const API  = {a: JSON.stringify(COMMENTS)}.a;

    async function fetchComments() {
      const url = new URL(API, location.origin);
      url.searchParams.set('slug', SLUG);
      const r = await fetch(url.toString(), { method: 'GET' });
      const data = await r.json();
      renderList(Array.isArray(data) ? data : []);
    }

    function renderList(list) {
      const wrap = document.getElementById('c-list');
      if (!list.length) { wrap.innerHTML = '<p>Nog geen reacties.</p>'; return; }
      wrap.innerHTML = list.map(c => `
        <div class="c-item">
          <div class="c-head"><strong>${escapeHTML(c.name||'Anoniem')}</strong> · <small>${new Date(c.createdAt).toLocaleString()}</small></div>
          <p>${escapeHTML(c.message||'')}</p>
        </div>`).join('');
    }
    function escapeHTML(s){return String(s).replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]))}

    document.getElementById('c-form').addEventListener('submit', async (e) => {
      e.preventDefault();
      const fd = new FormData(e.currentTarget);
      const payload = {
        slug: SLUG,
        name: (fd.get('name')||'').toString().trim(),
        message: (fd.get('message')||'').toString(),
        website: (fd.get('website')||'').toString(), // honeypot
      };
      const r = await fetch(API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });
      const data = await r.json().catch(()=> ({}));
      if (!r.ok) { alert(data?.error || 'Kon reactie niet plaatsen'); return; }
      (e.currentTarget).reset();
      fetchComments();
    });

    fetchComments().catch(()=>{});
  </script>

  <style>
    .comments { margin-top:2rem }
    form#c-form { display:grid; gap:.5rem; margin-bottom:1rem }
    .c-item { padding:.6rem .8rem; border:1px solid #e5e7eb; border-radius:.5rem; margin:.5rem 0; background:#fff }
    .c-head { color:#475569; margin-bottom:.25rem }
  </style>
</section>