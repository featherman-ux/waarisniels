---
// src/components/LikeButton.astro
import { apiUrl } from '../lib/api';

interface Props { key?: string }
const likeKey: string = (Astro.props?.key as string) ?? Astro.url.pathname.replace(/\/$/, '');
const ENDPOINT = apiUrl('/api/like');
---
<button id="like-btn" class="chip" data-key={likeKey}>üëç Like (<span id="like-cnt">0</span>)</button>

<script is:inline>
  (async () => {
    const btn = document.getElementById('like-btn');
    const span = document.getElementById('like-cnt');
    if (!btn || !span) return;

    const key = btn.dataset.key || 'site';
    const endpoint = {e: JSON.stringify(ENDPOINT)}.e;

    try {
      const r = await fetch(`${endpoint}?key=${encodeURIComponent(key)}`);
      const j = await r.json();
      span.textContent = String(j.count ?? 0);
    } catch {}

    btn.addEventListener('click', async () => {
      try {
        const r = await fetch(endpoint, {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ key }),
        });
        const j = await r.json();
        span.textContent = String(j.count ?? 0);
      } catch {}
    });
  })();
</script>

<style>
  .chip {
    background:#f1f5f9; border:1px solid #e5e7eb; color:#0f172a;
    padding:.3rem .65rem; border-radius:9999px; font-size:.85rem; font-weight:600;
    cursor:pointer;
  }
</style>