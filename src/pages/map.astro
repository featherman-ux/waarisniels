---
import BaseLayout from '../layouts/BaseLayout.astro';

const pageTitle = "Kaart";
const pageDescription = "Eenvoudige, snelle kaart met mijn route en stops (bus, motor, vlucht).";
---

<link
  slot="head"
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
/>
<script
  slot="head"
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  defer
></script>

<style>
  :root {
    --clr-primary:   #4f46e5;
    --clr-secondary: #10b981;
    --clr-accent:    #ffb703;
    --clr-light:     #f8f9fa;
    --clr-dark:      #e3e7ed;
  }
  .hero {
    background: var(--clr-primary);
    color: white;
    text-align: center;
    padding: 3rem 1rem;
    border-radius: 1rem;
    margin-bottom: 2rem;
    box-shadow: var(--shadow-md);
  }
  .hero h1 {
    font-size: 2rem;
    font-weight: 700;
    margin-bottom: .5rem;
  }
  .hero p {
    font-size: 1rem;
    opacity: .85;
  }
  .card {
    background: white;
    border-radius: 1rem;
    overflow: hidden;
    box-shadow: var(--shadow-md);
    max-width: 1280px;
    margin: 0 auto 2rem;
    padding: 0; /* no padding: map fills entire card */
  }
  .map-wrap {
    height: 600px;
    width: 100%;
  }
  .legend-bar {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 1rem;
    background: var(--clr-dark);
    padding: 1rem;
    font-size: .95rem;
    border-radius: 0 0 1rem 1rem;
  }
  .legend-item {
    display: flex;
    align-items: center;
    gap: .5rem;
    color: #374151;
  }
  .legend-line {
    width: 24px;
    height: 0;
    border-top-width: 3px;
    border-top-style: solid;
  }
  .note {
    text-align: center;
    margin: 1rem 0;
    color: var(--clr-text-subtle);
    font-size: .9rem;
  }
  .map-ai-panel {
    max-width: 720px;
    margin: 0 auto 3rem;
    background: white;
    border-radius: 1rem;
    border: 1px solid #e2e8f0;
    box-shadow: var(--shadow-md);
    padding: 1.5rem;
  }
  .map-ai-panel h3 {
    margin: 0 0 0.5rem;
    font-size: 1.1rem;
    color: #1f2937;
  }
  .map-ai-panel p {
    margin: 0;
    color: #4b5563;
    line-height: 1.6;
  }
  @media (max-width: 640px) {
    .map-wrap { height: 400px; }
    .hero h1 { font-size: 1.75rem; }
    .map-ai-panel { margin-bottom: 2rem; }
  }
</style>

<BaseLayout title={pageTitle} description={pageDescription}>
  <section class="hero">
    <h1>{pageTitle}</h1>
    <p>Hopelijk nu sneller en vloeiender!</p>
  </section>

  <aside id="map-ai-panel" class="map-ai-panel" aria-live="polite">
    <h3>AI Reisbuddy</h3>
    <p id="map-ai-text">niels is in Cusco. Je bent op weg naar Cusco, de historische hoofdstad van de Inca's! Kijk uit het raam en geniet van de adembenemende uitzichten op de Andes. Wacht maar tot je de majestueuze Sacsayhuamán-fortress ziet liggen, een van de meest indrukwekkende overblijfselen van de Inca-keizerlijke tijd.</p>
  </aside>

  <article class="card">
    <div id="map" class="map-wrap"></div>
    <div class="legend-bar">
      <div class="legend-item">
        <span class="legend-line" style="border-color: var(--clr-primary);"></span>Bus
      </div>
      <div class="legend-item">
        <span class="legend-line" style="border-color: var(--clr-secondary); border-style: dotted;"></span>Motor
      </div>
      <div class="legend-item">
        <span class="legend-line" style="border-color: var(--clr-accent); border-style: dashed;"></span>Vlucht
      </div>
      <div class="legend-item">
        <span class="legend-line" style="width:0;"></span>Stops / steden
      </div>
    </div>
  </article>

  <p class="note">Kaartdata wordt lokaal gecachet voor vlottere navigatie.</p>
</BaseLayout>

<script is:inline defer>
  document.addEventListener('DOMContentLoaded', async () => {
    if (typeof L === 'undefined') return;

    const map = L.map('map', {
      scrollWheelZoom: true,
      zoomControl: true,
      inertia: true,
    }).setView([-0.18, -78.47], 6);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '© OpenStreetMap contributors',
      maxZoom: 18,
      detectRetina: true,
    }).addTo(map);

    const [routeRes, placesRes] = await Promise.all([
      fetch('/data/route.geojson'),
      fetch('/data/places.json'),
    ]);
    const routeGeo = routeRes.ok ? await routeRes.json() : null;
    const places = placesRes.ok ? await placesRes.json() : [];

    if (routeGeo) {
      L.geoJSON(routeGeo, {
        style: ({ properties }) => {
          const m = properties.mode;
          if (m === 'flight') return { color: getComputedStyle(document.documentElement).getPropertyValue('--clr-accent').trim(), weight: 4, dashArray: '6 6' };
          if (m === 'motor') return { color: getComputedStyle(document.documentElement).getPropertyValue('--clr-secondary').trim(), weight: 4, dashArray: '2 8' };
          return { color: getComputedStyle(document.documentElement).getPropertyValue('--clr-primary').trim(), weight: 4 };
        },
      }).addTo(map);
    }

    const currentPlace = places[places.length - 1];

    const defaultIcon = L.icon({
      iconUrl: '/images/marker-icon.png',
      iconRetinaUrl: '/images/marker-icon-2x.png',
      shadowUrl: '/images/marker-shadow.png',
      iconSize: [25, 41],
      iconAnchor: [12, 41],
      popupAnchor: [1, -28],
      shadowSize: [41, 41],
    });

    const currentIcon = L.icon({
      iconUrl: '/images/marker-icon-2x.png',
      iconRetinaUrl: '/images/marker-icon-2x.png',
      shadowUrl: '/images/marker-shadow.png',
      iconSize: [30, 50],
      iconAnchor: [15, 50],
      popupAnchor: [1, -32],
      shadowSize: [50, 50],
    });

    const markers = places.map((p, index) => {
      const mk = L.marker([p.lat, p.lon], {
        icon: index === places.length - 1 ? currentIcon : defaultIcon,
      }).addTo(map);
      mk.bindPopup(`<strong>${p.name}</strong>${p.notes ? '<br>' + p.notes : ''}`);
      return mk;
    });

    const group = L.featureGroup(markers);
    if (group.getBounds().isValid()) {
      map.fitBounds(group.getBounds().pad(0.1));
    }

    const aiPanel = document.getElementById('map-ai-text');
    const defaultHighlight = "niels is in Cusco. Je bent op weg naar Cusco, de historische hoofdstad van de Inca's! Kijk uit het raam en geniet van de adembenemende uitzichten op de Andes. Wacht maar tot je de majestueuze Sacsayhuamán-fortress ziet liggen, een van de meest indrukwekkende overblijfselen van de Inca-keizerlijke tijd.";

    if (aiPanel) {
      aiPanel.textContent = defaultHighlight;
    }

    if (currentPlace && aiPanel) {
      try {
        const res = await fetch('/api/ai-place', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ place: currentPlace.name, notes: currentPlace.notes }),
        });
        const data = res.ok ? await res.json() : null;
        aiPanel.textContent = data?.highlight || defaultHighlight;
      } catch (error) {
        console.warn('AI highlight mislukt', error);
        aiPanel.textContent = defaultHighlight;
      }
    }
  });
</script>
